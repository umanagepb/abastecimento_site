import{D as e}from"./dom-9e6f7067.js";import{e as t}from"./dom-utils-728879e5.js";import{d as n,r as o}from"./disposable-d2c2d283.js";import"./_tslib-158249d5.js";var s,i;!function(e){e[e.Instant=0]="Instant",e[e.OnButtonClick=1]="OnButtonClick"}(s||(s={})),function(e){e[e.WaitingStart=0]="WaitingStart",e[e.PendingUpload=1]="PendingUpload",e[e.Uploading=2]="Uploading",e[e.Paused=3]="Paused",e[e.Complete=4]="Complete",e[e.Canceled=5]="Canceled",e[e.Error=6]="Error",e[e.Removing=7]="Removing"}(i||(i={}));class r{constructor(e,t,n){this._value=e,this._status=n.uploadMode===s.Instant?i.PendingUpload:i.WaitingStart,this._chunkIndex=0,this._loadedBytes=0,this._totalChunkCount=0,this._isFileExtensionValid=r.validateFileExtension(e,n),this._isMinSizeValid=r.validateMinFileSize(e,n),this._isMaxSizeValid=r.validateMaxFileSize(e,n),this._fileInfo={name:e.name,size:e.size,type:e.type,lastModified:1e4*e.lastModified+621355968e9,guid:t},this._request=null,this._onLoadStart=null,this._onProgress=null,this._onAbort=null,this._onPause=null,this._onError=null,this._onLoadEnd=null,this.isValid()||(this._status=i.Error)}get value(){return this._value}get status(){return this._status}set status(e){this._status=e}get chunkIndex(){return this._chunkIndex}set chunkIndex(e){this._chunkIndex=e}get loadedBytes(){return this._loadedBytes}set loadedBytes(e){this._loadedBytes=e}get totalChunkCount(){return this._totalChunkCount}set totalChunkCount(e){this._totalChunkCount=e}get isFileExtensionValid(){return this._isFileExtensionValid}get isMinSizeValid(){return this._isMinSizeValid}get isMaxSizeValid(){return this._isMaxSizeValid}get fileInfo(){return this._fileInfo}get request(){return this._request}set request(e){this._request=e}get onLoadStart(){return this._onLoadStart}set onLoadStart(e){this._onLoadStart=e}get onProgress(){return this._onProgress}set onProgress(e){this._onProgress=e}get onAbort(){return this._onAbort}set onAbort(e){this._onAbort=e}get onPause(){return this._onPause}set onPause(e){this._onPause=e}get onError(){return this._onError}set onError(e){this._onError=e}get onLoadEnd(){return this._onLoadEnd}set onLoadEnd(e){this._onLoadEnd=e}isValid(){return this.isFileExtensionValid&&this.isMaxSizeValid&&this.isMinSizeValid}isUploadComplete(){return this.loadedBytes>=this.fileInfo.size}loadStart(){this.status!==i.Uploading&&(this._status=i.Uploading,this.onLoadStart&&this.onLoadStart.call(this))}progress(){this.onProgress&&this.onProgress.call(this)}pause(){this._status=i.Paused,this.onPause&&this.onPause.call(this)}loadEnd(){this.isUploadComplete()&&(this._status=i.Complete,this.onLoadEnd&&this.onLoadEnd.call(this))}abort(){this.status!==i.Canceled&&(this._status=i.Canceled,this.request&&this.request.abort(),this.onAbort&&this.onAbort.call(this))}error(e){this._status=i.Error,this.onError&&this.onError.call(this,e)}static validateFileExtension(e,t){const n=t.allowedFileExtensions,o=e.name.substring(e.name.lastIndexOf(".")).toLowerCase();if(0===n.length)return!0;for(let e=0;e<n.length;e++)if(o===n[e].toLowerCase())return!0;return!1}static validateMinFileSize(e,t){const n=t.minFileSize;return!(n>0)||e.size>=n}static validateMaxFileSize(e,t){const n=t.maxFileSize;return!(n>0)||e.size<=n}}class a{upload(e,t,n){if(!e)return;e.totalChunkCount||(e.chunkIndex=0,e.totalChunkCount=a.calculateTotalChunkCount(e.fileInfo.size,t));const o=t.chunkSize*e.chunkIndex,s=e.value.slice(o,o+t.chunkSize),i=this.createFormData(t.name,s,e,t.requestData);e.request=d.sendRequest(i,{crossDomain:!1,url:t.uploadUrl,method:"POST",headers:t.requestHeaders,onAbort:()=>{e.abort()},onProgress:()=>{},onError:t=>{t.target&&e.error(t.target)},onLoadStart:()=>{e.loadStart()},onLoad:t=>{t.target&&(200===t.target.status?(e.chunkIndex++,e.loadedBytes+=s.size,e.progress(),n(e)):e.error(t.target))},onLoadEnd:null})}createFormData(e,t,n,o){const s=new FormData;s.append(e,t),s.append("chunkMetadata",JSON.stringify({FileName:n.fileInfo.name,FileSize:n.fileInfo.size,FileType:n.fileInfo.type,LastModified:n.fileInfo.lastModified,FileGuid:n.fileInfo.guid,Index:n.chunkIndex,TotalCount:n.totalChunkCount}));for(const e in o)Object.prototype.hasOwnProperty.call(o,e)&&s.append(e,o[e]);return s}static calculateTotalChunkCount(e,t){let n=Math.trunc(e/t.chunkSize);return e%t.chunkSize>0&&n++,n}}class l{upload(e,t,n){if(!e)return;const o=this.createFormData(t.name,e,t.requestData);let s=!1;e.request=d.sendRequest(o,{url:t.uploadUrl,method:"POST",headers:t.requestHeaders,crossDomain:!1,onProgress:t=>{s=!0,e.loadedBytes=t.loaded>e.fileInfo.size?e.fileInfo.size:t.loaded,e.progress()},onAbort:t=>{e.abort()},onError:t=>{t.target&&e.error(t.target)},onLoadStart:t=>{e.loadStart()},onLoad:t=>{t.target&&(200===t.target.status?(s||(e.loadedBytes=e.fileInfo.size,e.progress()),n(e,t)):e.error(t.target))},onLoadEnd:null})}createFormData(e,t,n){const o=new FormData;o.append(e,t.value);for(const e in n)Object.prototype.hasOwnProperty.call(n,e)&&o.append(e,n[e]);return o}}class d{static sendRequest(e,t){const n=new XMLHttpRequest;t.crossDomain=d.isCrossDomain(t.url);const o=d.getRequestHeaders(t);n.open(t.method,t.url,!0),t.onLoadStart&&(n.upload.onloadstart=t.onLoadStart),t.onLoad&&(n.onload=t.onLoad),t.onLoadEnd&&(n.upload.onloadend=t.onLoadEnd),t.onProgress&&(n.upload.onprogress=t.onProgress),t.onError&&(n.upload.onerror=t.onError),t.onAbort&&(n.upload.onabort=t.onAbort);for(const e in o)Object.prototype.hasOwnProperty.call(o,e)&&o[e]&&n.setRequestHeader(e,o[e]);return n.send(e),n}static getRequestHeaders(e){const t=e.headers||{};return t.Accept=t.Accept||d.getAcceptHeader(),e.crossDomain||t["X-Requested-With"]||(t["X-Requested-With"]="XMLHttpRequest"),t}static getAcceptHeader(){return"*/*"}static isCrossDomain(e){let t=!1;const n=document.createElement("a"),o=document.createElement("a");n.href=window.location.href;try{o.href=e,o.href=o.href,t=n.protocol+"//"+n.host!=o.protocol+"//"+o.host}catch(e){t=!0}return t}}function u(s,i,r,a,l){s=t(s),r=t(r),a=i.buttonCssSelector?document.querySelector(i.buttonCssSelector):t(a);let d=null;i.dropZoneCssSelector&&(d=document.querySelector(i.dropZoneCssSelector)),r&&n(r),a&&n(a),d&&n(d);let u=null,f=null,p=null,g=null,m=null;const E=s;return E.files||(s.files=[]),r&&(i.multiple&&r.setAttribute("multiple",""),i.acceptedFileTypes&&r.setAttribute("accept",i.acceptedFileTypes.join(",")),u=()=>{c(r.files,l,i).then((e=>{h(e,E,l),r.value=""}))},r.addEventListener("change",u),a&&(f=()=>r.click(),a.addEventListener("click",f)),d&&(p=e=>{e.preventDefault(),c(function(e,t){const n=[];if(e)if(e.items){for(let t=0,o=e.items[t];o;t++,o=e.items[t])if("file"===o.kind){const e=o.getAsFile();e&&n.push(e)}}else for(let t=0,o=e.files[t];o;t++,o=e.files[t])n.push(o);return t.multiple?n:[n[0]]}(e.dataTransfer,i),l,i).then((e=>{h(e,E,l)})),m&&m(e)},g=t=>{i.dragOverClassName&&t.srcElement&&e.addClassName(t.srcElement,i.dragOverClassName),t.preventDefault()},m=t=>{i.dragOverClassName&&e.removeClassName(t.srcElement,i.dragOverClassName)},d.addEventListener("drop",p),d.addEventListener("dragover",g),d.addEventListener("dragleave",m))),o(r,(function(){u&&r.removeEventListener("change",u)})),a&&o(a,(function(){f&&a.removeEventListener("click",f)})),d&&o(d,(function(){d&&(p&&d.removeEventListener("drop",p),g&&d.removeEventListener("dragover",g),m&&d.removeEventListener("dragover",m))})),Promise.resolve("ok")}async function c(e,t,n){if(!e)return[];const o=await t.invokeMethodAsync("CreateFileGuids",e.length),s=[],i=n.acceptedFileTypes&&n.acceptedFileTypes.length>0?n.acceptedFileTypes.map((e=>e.trim())):null;for(let t=0,a=e[t];a;t++,a=e[t]){const l=new r(a,o[t],n);l.isValid()&&i&&!f(e[t],i)||s.push(l)}return s}function f(e,t){return t.some((function(t){if("."===t[0]){if(t=t.replace(".","\\."),e.name.match(new RegExp(t+"$","i")))return!0}else if(t=t.replace("*",""),e.type.match(new RegExp(t,"i")))return!0}))}function h(e,t,n){t.files&&0!==e.length&&(t.files=t.files.concat(e),m(t.files,n).then((()=>{e.forEach((e=>p(e,t,n)))})))}function p(e,t,n){e&&e.isValid()&&e.status!==i.WaitingStart&&e.status!==i.Error&&function(e,t){return E("FileUploadStart",e,t)}(e,n).then((t=>{!function(e,t){e.onLoadStart=()=>{!function(e,t){E("FileUploadStarted",e,t)}(e,t)},e.onProgress=()=>{!function(e,t){E("FileProgress",e,t)}(e,t)},e.onAbort=()=>{!function(e,t){E("FileUploadAborted",e,t)}(e,t)},e.onPause=()=>{!function(e,t){E("FileUploadPaused",e,t)}(e,t)},e.onError=n=>{!function(e,t,n,o,s){s.invokeMethodAsync("FileUploadError",S(e),t,n,o)}(e,n.status,n.statusText,n.responseText,t)},e.onLoadEnd=()=>{!function(e,t){E("FileUploaded",e,t)}(e,t)}}(e,n),t?t.uploadUrl?g(e,t):e.error(new EventTarget):e.abort()}))}function g(e,t,n,o){(t.chunkSize>0?new a:new l).upload(e,t,(e=>{e.loadEnd(),e.isUploadComplete()||e.status!==i.Uploading||g(e,t)}))}function m(e,t){return t.invokeMethodAsync("SelectedFilesChanged",e.map((e=>S(e))))}function E(e,t,n){return n.invokeMethodAsync(e,S(t))}function S(e){return{Name:e.fileInfo.name,Size:e.fileInfo.size,Type:e.fileInfo.type,LastModified:e.fileInfo.lastModified,Guid:e.fileInfo.guid,LoadedBytes:e.loadedBytes,Status:e.status,IsFileExtensionValid:e.isFileExtensionValid,IsMinSizeValid:e.isMinSizeValid,IsMaxSizeValid:e.isMaxSizeValid}}function v(e,t,n,o){e.files&&e.files.forEach((e=>{t.forEach((t=>{e.fileInfo.guid===t&&(e.status=i.PendingUpload,p(e,0,o))}))}))}function _(e,t){e.files&&e.files.forEach((e=>{t.forEach((function(t){e.fileInfo.guid===t&&e.pause()}))}))}function C(e,t){const n=e.files;n&&n.forEach((e=>{t.forEach((t=>{e.fileInfo.guid===t&&e.abort()}))}))}async function F(e,t,n,o){const s=e.files;if(!s)return Promise.reject();if(0===s.filter((e=>t.indexOf(e.fileInfo.guid)>-1)).length)return Promise.resolve();e.files=I(s,t);const r=await c(s.map((e=>e.value)),o,n);e.files=s.concat(r),function(e,t,n){n.invokeMethodAsync("FileReloaded",e,t)}(t,r.map((function(e){return e.fileInfo.guid})),o),r.forEach((function(e){e.status=i.PendingUpload,p(e,0,o)}))}function L(e,t,n,o){e.files&&(e.files=I(e.files,t),m(e.files,o))}function I(e,t){return e.filter((e=>-1===t.indexOf(e.fileInfo.guid)))}function y(e){return(e=t(e))&&n(e),Promise.resolve("ok")}const P={init:u,dispose:y,startFileUpload:v,pauseFileUpload:_,abortFileUpload:C,removeFiles:L,reloadFile:F};export{C as abortFileUpload,P as default,y as dispose,u as init,_ as pauseFileUpload,F as reloadFile,L as removeFiles,v as startFileUpload};
