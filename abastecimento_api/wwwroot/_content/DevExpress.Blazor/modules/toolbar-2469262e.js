import{D as t}from"./dom-9e6f7067.js";import{e,j as i,k as s,D as o,R as n,f as r,u as a,E as l}from"./dom-utils-728879e5.js";import{d as c}from"./disposable-d2c2d283.js";import{S as u}from"./observables-589a5615.js";import{initFocusHidingEvents as h}from"./focus-utils-3a7c8e37.js";import{P as d}from"./supportcaptureelement-2f30b59b.js";import{D as m}from"./dx-dropdown-owner-2e57b57e.js";import"./_tslib-158249d5.js";import"./touch-585ccec1.js";import"./popuproot-4df55582.js";import"./branch-6684bbdd.js";import"./lit-element-d284a100.js";import"./property-ba1fa369.js";import"./data-qa-utils-8be7c726.js";import"./capturemanager-c228e074.js";import"./eventhelper-dec6cde0.js";import"./rafaction-bba7928b.js";import"./dx-ui-element-4d613bb9.js";import"./layouthelper-c2462bd3.js";import"./rect-2684652a.js";import"./point-9c6ab88a.js";import"./popup-77a1ae4b.js";import"./transformhelper-3935ca6a.js";import"./positiontracker-9570b24e.js";import"./positiontrackerobserver-5fd93b2c.js";class p{constructor(t){this.items=[],this.isLocked=!1,this.subscriptions=[],t&&this.addRange(t)}subscribe(t){this.isLocked||t(this.getChanges(this.items,[])),this.subscriptions.push(t)}getChanges(t,e){return{addedItems:t||[],removedItems:e||[]}}forEach(t,e){this.items.forEach(t,e)}selectMany(t,e){return this.map(t,e).reduce((function(t,e){return t.concat(e)}),[])}reduce(t,e){return this.items.reduce(t,e)}map(t,e){return this.items.map(t,e)}filter(t,e){return this.items.filter(t,e)}any(){return this.count()>0}count(){return this.items.length}get(t){return this.items[t]}add(t){this.addItemCore(t)&&this.raiseChanges([t],[])}remove(t){this.removeItemCore(t)&&this.raiseChanges([],[t])}addRange(t){this.raiseChanges(t.map(this.addItemCore.bind(this)).filter((function(t){return!!t})),[])}removeRange(t){this.raiseChanges([],t.map(this.removeItemCore.bind(this)).filter((function(t){return!!t})))}addItemCore(t){return this.items.indexOf(t)>-1?null:this.items[this.items.length]=t}removeItemCore(t){const e=this.items.indexOf(t);return-1===e?null:this.items.splice(e,1)[0]}raiseChanges(t,e){const i=this.getChanges(t,e);(i.addedItems.length>0||i.removedItems.length>0)&&this.subscriptions.forEach((function(t){t(i)}))}lock(){this.isLocked=!0}unlock(){this.isLocked=!1}}class g{constructor(t,e,i){var s;this.layer=t,this.block=e,this.width=0,this._blockCollection=void 0;const o=e.getGroupElement();o&&(this._blockCollection=this.layer.getBlockCollection(o),null===(s=this._blockCollection)||void 0===s||s.push(e)),i.subscribe(e,((t,i=!1)=>{var s;null===t&&(t=null===(s=this.layer.getPrevLayer())||void 0===s?void 0:s.getActualBlocks().filter((function(t){return t.block===e}))[0].width),t!==this.width&&(this.width=null!=t?t:0,i||this.layer.requestUpdateLayoutModel())}))}get blockCollection(){return this._blockCollection||new f(null)}getMinWidth(){return this.width}getMaxWidth(t){return this.getMinWidth()}}class b extends g{getPrevLayerMinWidth(){const t=this.layer.getPrevLayer();return t?t.getActualBlocks().filter((t=>t.block===this.block))[0].getMinWidth():0}getMaxWidth(t){return t===this.layer?this.getPrevLayerMinWidth():this.getMinWidth()}}class f{constructor(t){this.id=t,this._margins=void 0,this.blocks=[]}push(t){this.blocks.includes(t)||this.blocks.push(t),this.update()}toArray(){return Array.from(this.blocks)}get margins(){return this._margins||0}update(){if(!this._margins&&this.blocks.length){const e=this.blocks[0].getGroupElement();if(e){const i=t.getCurrentStyle(e);this._margins=t.pxToInt(i.marginRight)+t.pxToInt(i.marginLeft)}}}}class y extends g{}class k extends g{}class C{constructor(t,e){this.widthCalculator=t,this.triggersResolver=e,this.widthCalculator=t,this.triggersResolver=e}subscribe(t,e){const i=this.widthCalculator.bind(this);this.triggersResolver(t).forEach((function(s){s.subscribe((function(){t.isWidthCalculationLocked||o((function(){e(i(t),!1)}))}),!0)})),o((function(){e(i(t),!0)}))}}const x={fullWidthItem:new C((function(t){return t.getWidth()}),_),fullWidthSystemItem:new C((function(t){return t.getWidth()}),(function(t){return[]})),titleItem:new C((function(t){return t.getWidth()}),(function(t){var e,i;return[null===(e=t.toolbar.title)||void 0===e?void 0:e.hasTitle,null===(i=t.toolbar.title)||void 0===i?void 0:i.text]})),noTextItem:new C((function(t){return t.getNoTextWidth()}),_),contextItem:function(t){return new C((function(e){return t.items.filter((function(t){return"item"===t.getName()&&t.index<e.index&&t.isVisible()})).length>=e.toolbar.minRootItems||!e.isVisible()?0:null}),_)},hiddenItem:new C((function(){return 0}),(function(){return[]}))};class v{constructor(t,e,i,s){this.stateName=t,this.blockUpdaterGetter=e,this.prevLayer=i,this.canApply=s,this.nextLayer=null,this.layoutBlocks=[],this.nextLayer=null,i&&(i.nextLayer=this)}getNextLayer(){return null!=this.nextLayer?this.nextLayer.canApply()?this.nextLayer:this.nextLayer.getNextLayer():null}getPrevLayer(){return null!=this.prevLayer?this.prevLayer.canApply()?this.prevLayer:this.prevLayer.getPrevLayer():null}requestUpdateLayoutModel(){var t;null===(t=this.getPrevLayer())||void 0===t||t.requestUpdateLayoutModel()}getBlockCollection(t){var e;return null===(e=this.getPrevLayer())||void 0===e?void 0:e.getBlockCollection(t)}isValidWidth(t){if(!this.canApply()||!t)return!1;const e=this.getRange();return!this.getNextLayer()&&e.min>t||!this.getPrevLayer()&&e.max<t||e.min<=t&&e.max>=t}getRange(){const t=new Set,e=this.latestRange=this.getActualBlocks().reduce(((e,i)=>(t.add(i.blockCollection),{min:e.min+i.getMinWidth(),max:e.max+i.getMaxWidth(this)})),{min:0,max:0});return t.forEach((t=>{e.min+=t.margins,e.max+=t.margins})),e}getActualBlocks(){const t=this.getPrevLayer();return t?t.getActualBlocks().map((t=>this.layoutBlocks.filter((function(e){return e.block===t.block}))[0]||t)):this.layoutBlocks}activate(t){t&&this.layoutBlocks.forEach((t=>{t.block.updateState(this.stateName)}))}addBlock(t){const e=this.blockUpdaterGetter(t);e&&this.layoutBlocks.push(this.createBlock(t,e))}removeBlock(t){}activateAndReset(t){}}class L extends v{constructor(t,e,i,s){super(t,e,null,s),this.layoutModel=i,this.blockCollection=new Map}requestUpdateLayoutModel(){this.layoutModel.updateLayout()}createBlock(t,e){return new k(this,t,e)}activateAndReset(t){this.activate(t),this.layoutBlocks.forEach((t=>{t.block.reset()}))}getBlockCollection(t){return this.getBlockCollectionCore(t)}getBlockCollectionCore(t){let e=this.blockCollection.get(t);return e||this.blockCollection.set(t,e=new f(t)),e}}class I extends v{activate(t){const e=this.getActualBlocks();let i=this.latestRange.max,s=this.stateName;const o=new Map;for(let n=e.length-1;n>=0;n--){const r=e[n];if(i>t){i-=r.getMaxWidth(this)-r.getMinWidth();const e=r.blockCollection.id,n=(o.has(e)?o:o.set(e,r.blockCollection.toArray())).get(e);if(n&&(n.splice(n.indexOf(r.block),1),n.length||(i-=r.blockCollection.margins)),i<=t){r.block.updateState(s);const t=this.getPrevLayer();s=t?t.stateName:"";continue}}r.block.updateState(s)}}getRange(){const t=new Set;return this.latestRange=this.getActualBlocks().reduce(((e,i)=>(t.add(i.blockCollection),{min:e.min+i.getMinWidth(),max:e.max+i.getMaxWidth(this)})),{min:0,max:0}),t.forEach((t=>{this.latestRange.max+=t.margins})),this.latestRange}createBlock(t,e){return new b(this,t,e)}}class w extends v{createBlock(t,e){return new y(this,t,e)}getRange(){const t=new Set;let e=this.getActualBlocks().reduce((function(e,i){return t.add(i.blockCollection),e+i.getMinWidth()}),0);t.forEach((t=>{e+=t.margins}));const i=this.getPrevLayerRangeMax();return this.latestRange={min:e,max:i}}getPrevLayerRangeMax(){const t=this.getPrevLayer();return t?t.getRange().max-1:0}}class M{constructor(t){this.onLayerApplied=t,this.layers=[],this.currentWidth=null,this.currentHeight=null}initialize(t,e,i){this.elementContentWidthSubscription=r(e,(e=>{this.currentWidth===e.width&&this.currentHeight===e.height||(null===this.currentWidth&&t.subscribe((t=>{t.addedItems.forEach(this.addBlock.bind(this)),t.removedItems.forEach(this.removeBlock.bind(this))})),this.currentWidth=e.width,this.currentHeight=e.height,i&&i(e))}))}dispose(){this.elementContentWidthSubscription&&a(this.elementContentWidthSubscription)}getLastLayer(){return this.layers[this.layers.length-1]||null}defaultLayer(t,e){this.layers.push(new L("default",t,this,e))}simultaneousTransitionLayer(t,e,i){this.layers.push(new w(t,e,this.getLastLayer(),i))}sequentialTransitionLayer(t,e,i){this.layers.push(new I(t,e,this.getLastLayer(),i))}addBlock(t){this.layers.forEach((function(e){e.addBlock(t)}))}removeBlock(t){this.layers.forEach((function(e){e.removeBlock(t)}))}updateLayout(){const t=this.findLayersForWidth(this.currentWidth);t.length>0&&this.applyLayer(t[0])}resetToDefault(){this.applyLayer(this.layers[0],!0)}applyLayer(t,e=!1){e?t.activateAndReset(this.currentWidth):t.activate(this.currentWidth),this.onLayerApplied&&this.onLayerApplied(t)}findLayersForWidth(t){return this.layers.filter((function(e){return e.isValidWidth(t)}))}forceUpdate(){null!==this.currentWidth&&this.updateLayout()}}class W{constructor(t){this.toolbar=t,this.state="",this._isWidthCalculationLocked=!1,this.index=-1}getWidth(){return this.isVisible()?O(this.getElement(),!1,true):0}getNoTextWidth(){return this.getWidth()}isVisible(){return!0}get isWidthCalculationLocked(){return this._isWidthCalculationLocked}updateState(t){this.state=t,this.updateStateCore(t)}updateStateCore(t){}lockWidthCalculation(){this._isWidthCalculationLocked=!0}unlockWidthCalculation(){this._isWidthCalculationLocked=!1}getGroupElement(){return null}reset(){}}class E extends W{constructor(t,e){super(t),this.item=e}getElement(){return this.item.getElement()}updateStateCore(t){this.item.isDisplayed.update(t.indexOf("has-"+this.getName())>-1)}updateVisible(t){t||this.lockWidthCalculation(),this.item.updateVisible(t),t&&this.unlockWidthCalculation()}}class S extends E{constructor(t,e){super(t,e)}getNoTextWidth(){return this.item.isDisplayed.value?function(e){let i=O(e,!1,true);if(e){const s=e.querySelector(".image");if(s){i-=G(s);let e=s;for(;e=e.nextElementSibling;)U(e)||"absolute"===t.getCurrentStyle(e).position||(i-=O(e))}}return i}(this.getElement()):0}getName(){return"item"}isVisible(){return this.item.isDisplayed.value}updateStateCore(t){const e=this.item.toolbar;this.updateVisible(e.minRootItems>0?-1===t.indexOf("has-ellipsis")||this.index<e.minRootItems:-1===t.indexOf("has-ellipsis")&&-1===t.indexOf("has-sidemenu"))}getGroupElement(){return this.item.getGroupElement()}}class R extends E{constructor(t,e){super(t,e)}getName(){return"ellipsis"}updateStateCore(t){super.updateStateCore(t),this.updateVisible(this.item.isDisplayed.value)}reset(){this.updateVisible(!0)}}class B extends S{constructor(t,e){super(t,e),this.itemBlocks=[],this.addItem(e)}addItem(t){this.itemBlocks.push(new S(this.toolbar,t))}isVisible(){return this.itemBlocks.reduce((function(t,e){return t&&e.isVisible()}),!0)}getWidth(){return this.itemBlocks.reduce((function(t,e){return t+e.getWidth()}),0)}getNoTextWidth(){return this.itemBlocks.reduce((function(t,e){return t+e.getNoTextWidth()}),0)}updateVisible(t){this.itemBlocks.forEach((function(e){e.updateVisible(t)}))}tryAddItem(t){const e=this.itemBlocks[this.itemBlocks.length-1].item,i=e.groupName===t.groupName&&e.group===t.group&&e.adaptivePriority.value===t.adaptivePriority.value;return i&&this.addItem(t),i}}class V extends W{constructor(t,e){super(t),this.item=e}getName(){return"title"}getWidth(){return O(this.getElement(),!1,true)}getElement(){return this.item.getElement()}}class N{constructor(t,e){this.element=t,this.toolbar=e,this.index=new u(-1),this.isVisible=new u(this.defaultIsVisible()),this.isVisible.subscribe((t=>{this.onIsVisibleChanged(t)}),!0)}defaultIsVisible(){return!0}getElement(){return this.element}updateVisible(t){this.isVisible.update(t)}onIsVisibleChanged(t){const e=this.getElement();e&&(t?this.show(e):this.hide(e))}show(t){t.classList.remove("ta-hidden-item")}hide(t){t.classList.add("ta-hidden-item")}}class A extends N{constructor(){super(...arguments),this.isDisplayed=new u(!0),this.text=new u(""),this.iconCssClass=new u("")}show(t){t.style.display=""}hide(t){t.style.display="none"}getGroupElement(){return null}}class T extends A{constructor(t,e,i){super(t,e),this.group=i,this.groupName=new u(""),this.adaptivePriority=new u(-1)}onIsVisibleChanged(t){super.onIsVisibleChanged(t),this.group.onItemVisibleChanged()}getElement(){return document.querySelector(z("data-dxtoolbar-item-id",this.id))}getParent(){const t=this.getElement();return t&&t.parentElement?t.parentElement:null}getGroupElement(){return this.group.getElement()}}class P extends A{constructor(t,e){super(t,e)}defaultIsVisible(){return null}}class j extends N{constructor(t,e){super(t,e),this.items=[]}addItem(t){this.items.push(t)}onItemVisibleChanged(){if(0===this.items.length)return;const t=this.items.some((t=>t.isVisible.value));this.updateVisible(t)}getElement(){if(0===this.items.length)return null;const t=s(this.items[0].getElement(),z("data-dxtoolbar-group-id",this.toolbar.id));return t||this.items[0].getParent()}}class q extends N{constructor(t,e){super(null,t),this.elementSelector=e,this.hasTitle=new u(!1),this.text=new u(""),this.text.subscribe((t=>{this.hasTitle.update(null!=t&&""!==t)}))}getElement(){return document.querySelector(this.elementSelector)}}class D{constructor(t,e){this.element=t,this.id=e,this.items=[],this.itemMap=new Map,this.groupMap=new Map,this.canHideRootItems=!1,this.canCollapseToIcons=!1,this.minRootItems=0}}class H{constructor(){this.isLoading=!0,this.isLayoutCalculated=!1,this.toolbar=null,this.layoutModel=null,this.reinitRequested=!1}init(e,n,r){this.isLayoutCalculated=!1;const a=r,l=e.dataset.dxtoolbarId,c=z("data-dxtoolbar-title-id",l),u=z("data-dxtoolbar-ellipsis-id",l),h=document.querySelector(u),d=this.toolbar=new D(e,l),m=d.groupMap;Array.from(n.items).forEach((t=>{const e=document.querySelector(z("data-dxtoolbar-item-id",t.id)),i=s(e,z("data-dxtoolbar-group-id",l));let o=null;m.has(i)&&(o=m.get(i)),o||(o=new j(i,d),m.set(i,o));const n=new T(e,d,o);n.text.update(t.text),n.groupName.update(t.groupName),n.adaptivePriority.update(t.adaptivePriority),n.iconCssClass.update(t.iconCssClass),n.isDisplayed.update(t.visible),n.index.update(t.index),n.id=t.id,d.itemMap.set(n.id,n),d.items.some((t=>t.index.value===n.index.value))||(o.addItem(n),d.items.push(n))})),d.canHideRootItems=n.canHideRootItems,d.canCollapseToIcons=n.canCollapseToIcons,d.minRootItems=n.minRootItems,d.itemSize=n.itemSize,d.renderMode=n.renderMode,d.itemSpacing=n.itemSpacingMode;const g=new p([]),b=new q(d,c);b.text.update(n.title),d.title=b,g.add(new V(d,b));const f=Array.from(m.values()),y=f.some((t=>t))?f.map((t=>t.items)).reduce(((t,e)=>t.concat(e))):[];g.addRange(this.getItemsBlocks(d,y));const k=new P(h,d);k.id=n.adaptiveMenuModel.id,g.add(new R(d,k)),d.ellipsisViewModel=k;const C=x.contextItem(g),v=this.layoutModel=new M((s=>{if(!this.isLayoutCalculated){this.isLayoutCalculated=!0;const t=d.element;o((()=>{const e=t.querySelector(".btn-toolbar");this.updateControlStyles(d,Math.ceil(!this.isLoading&&e?e.offsetHeight:t.offsetHeight)),this.isLoading=!1}))}const n=d.element.querySelector(".btn-toolbar")||d.element;if(s.stateName.indexOf("no-item-text")>-1?t.addClassName(n,"no-item-text"):t.removeClassName(n,"no-item-text"),t.removeClassName(e,"dxbs-loading"),i(e))return;const r=d.items.concat(d.ellipsisViewModel).map((t=>({Id:t.id,IsVisible:t.isVisible.value})));a.invokeMethodAsync("OnModelUpdated",Array.from(r)).catch((function(t){i(e)||console.error(t)}))}));v.defaultLayer((function(t){switch(t.getName()){case"item":return x.fullWidthItem;case"title":return x.titleItem}return x.hiddenItem}),(()=>!0)),v.sequentialTransitionLayer("has-ellipsis",(function(t){switch(t.getName()){case"ellipsis":return x.fullWidthSystemItem;case"item":return C}}),(()=>d.canHideRootItems&&d.minRootItems>0)),v.simultaneousTransitionLayer("no-item-text",(function(t){switch(t.getName()){case"item":return x.noTextItem;case"ellipsis":return x.hiddenItem}}),(()=>d.canCollapseToIcons)),v.sequentialTransitionLayer(d.canCollapseToIcons?"no-item-text has-ellipsis":"has-ellipsis",(function(t){switch(t.getName()){case"item":return C;case"ellipsis":return x.fullWidthSystemItem}}),(()=>d.canHideRootItems)),v.initialize(g,d.element.querySelector(".btn-toolbar")||d.element,(t=>{var e;this.height!==t.height&&(this.isLayoutCalculated=!1,this.height=t.height),null===(e=this.layoutModel)||void 0===e||e.updateLayout()}))}reinit(t,e){this.reinitRequested||(this.reinitRequested=!0,n((()=>{this.resetToDefault(),this.disposeModel(),n((()=>{this.reinitRequested=!1,this.init(t.mainElement,t,e)}))})))}resetToDefault(){var t;null===(t=this.layoutModel)||void 0===t||t.resetToDefault()}update(t,e){var i,s;if(!this.toolbar)return;let o=!1,n=!1;if(this.toolbar.canHideRootItems!==t.canHideRootItems&&(this.toolbar.canHideRootItems=t.canHideRootItems,o=!0),this.toolbar.canCollapseToIcons!==t.canCollapseToIcons&&(this.toolbar.canCollapseToIcons=t.canCollapseToIcons,o=!0),this.toolbar.minRootItems!==t.minRootItems&&(this.toolbar.minRootItems=t.minRootItems,o=!0),this.toolbar.itemSize!==t.itemSize&&(this.toolbar.itemSize=t.itemSize,n=!0),this.toolbar.renderMode!==t.renderMode&&(this.toolbar.renderMode=t.renderMode,n=!0),this.toolbar.itemSpacing!==t.itemSpacingMode&&(this.toolbar.itemSpacing=t.itemSpacingMode,n=!0),null===(i=this.toolbar.title)||void 0===i||i.text.update(t.title),!n){const e=Array.from(t.items).map((t=>t.id)),i=Array.from(this.toolbar.itemMap.values()).map((t=>t.id));n=!((r=e).length===(a=i).length&&r.every(((t,e)=>t===a[e])))}var r,a;n?this.reinit(t,e):(Array.from(t.items).forEach((t=>{if(!this.toolbar)return;const e=this.toolbar.itemMap.get(t.id);e&&(e.text.update(t.text),e.groupName.update(t.groupName),e.adaptivePriority.update(t.adaptivePriority),e.index.update(t.index),e.iconCssClass.update(t.iconCssClass),e.isDisplayed.update(t.visible))})),o&&(null===(s=this.layoutModel)||void 0===s||s.forceUpdate()))}disposeModel(){var t;null===(t=this.layoutModel)||void 0===t||t.dispose()}dispose(){this.disposeModel()}getItemsBlocks(t,e){return e.reduce(((e,i)=>e.group&&e.group.tryAddItem(i)?e:i.groupName.value?{group:e.blocks[e.blocks.length]=new B(t,i),blocks:e.blocks}:{group:null,blocks:e.blocks.concat([new S(t,i)])}),{blocks:[],group:null}).blocks.sort((function(t,e){return t.item.adaptivePriority.value-e.item.adaptivePriority.value})).map((function(t,e){return t.index=e,t}))}updateControlStyles(t,e){t.element.style.height=e+"px"}}function _(t){return[t.item.text,t.item.isDisplayed,t.item.iconCssClass]}function O(e,i=!1,s=!1){let o=e?Math.ceil(e.offsetWidth+(i?0:G(e))):0;if(e&&e.parentElement&&!s){if(e.parentElement.lastElementChild===e){const i=t.getCurrentStyle(e.parentElement);o+=t.pxToInt(i.marginRight)}if(e.parentElement.firstElementChild===e){const i=t.getCurrentStyle(e.parentElement);o+=t.pxToInt(i.marginLeft)}}return o}function G(t){return l(t)}function U(e){return t.hasClassName(e,"popout")}function z(t,e){return`[${t}=${e}]`}const $=new Map;function F(t,i,s){if(!(t=e(t)))return Promise.reject("failed");let o=$.get(t);o?o.update(i,s):(o=new H,o.init(t,i,s),$.set(t,o));const n=t.querySelector(".btn-toolbar")||t;return h(n),Promise.resolve("ok")}function J(t){return s(t=e(t),$),Array.from($.keys()).forEach((t=>{i(t)&&s(t,$)})),Promise.resolve("ok");function s(t,e){if(!t)return;const i=t.querySelector(".btn-toolbar");i&&c(i);const s=e.get(t);null==s||s.dispose(),e.delete(t)}}customElements.define("dxbl-toolbar-menu-item",class extends m{constructor(){super(...arguments),this.boundOnButtonClick=this.onButtonClick.bind(this)}connectedCallback(){super.connectedCallback(),this.addEventListener("click",this.boundOnButtonClick)}disconnectedCallback(){this.removeEventListener("click",this.boundOnButtonClick),super.disconnectedCallback()}canHandlePointerDown(t){return d.containsInComposedPath(t,this)}onButtonClick(t){if(null===this.getAttribute("submit-form-on-click"))return;const e=this.getAttribute("data-dxtoolbar-container-id");if(e){const t=document.querySelector(`[data-dxtoolbar-id=${e}]`);if(t){const e=document.createElement("input");e.type="submit",e.hidden=!0,t.appendChild(e),e.click(),t.removeChild(e)}}}});const K={init:F,dispose:J};export{K as default,J as dispose,F as init};
